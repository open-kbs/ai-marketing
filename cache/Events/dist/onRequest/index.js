(()=>{"use strict";var e={};(()=>{e.d=(t,s)=>{for(var a in s){if(e.o(s,a)&&!e.o(t,a)){Object.defineProperty(t,a,{enumerable:true,get:s[a]})}}}})();(()=>{e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{e.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();if(typeof e!=="undefined")e.ab=__dirname+"/";var t={};e.r(t);e.d(t,{handler:()=>a});const getSora2PromptingGuide=()=>({type:"SORA2_PROMPTING_GUIDE",data:{before_you_prompt:`Think of prompting like briefing a cinematographer who has never seen your storyboard. If you leave out details, they'll improvise ‚Äì and you may not get what you envisioned. By being specific about what the "shot" should achieve, you give the model more control and consistency to work with.\n\nBut leaving some details open can be just as powerful. Giving the model more creative freedom can lead to surprising variations and unexpected, beautiful interpretations. Both approaches are valid: detailed prompts give you control and consistency, while lighter prompts open space for creative outcomes.\n\nTreat your prompt as a creative wish list, not a contract. Using the same prompt multiple times will lead to different results ‚Äì this is a feature, not a bug. Each generation is a fresh take, and sometimes the second or third option is better.`,api_parameters:{important:"These MUST be set explicitly in API call, NOT in prose:",model:{options:["sora-2","sora-2-pro"]},size:{"sora-2":["1280x720","720x1280"],"sora-2-pro":["1280x720","720x1280","1024x1792","1792x1024"],note:"Resolution directly influences visual fidelity and motion consistency"},seconds:{options:["4","8","12"],default:"4",tip:"Shorter clips follow instructions more reliably. Consider 2x4s instead of 1x8s"}},prompt_anatomy:{description:"A clear prompt describes a shot as if you were sketching it onto a storyboard",what_works:["State the camera framing","Note depth of field","Describe action in beats","Set lighting and palette","Anchor subject with distinctive details","Keep to single, plausible action"],length_guidance:{short:"Gives model creative freedom, expect surprising results",detailed:"Restricts creativity but provides more control"},example_short:{prompt:"In a 90s documentary-style interview, an old Swedish man sits in a study and says, 'I still remember when I was young.'",why_it_works:["90s documentary sets style - model chooses lens, lighting, color grade","Basic subject/setting lets model take creative liberties","Simple dialogue that Sora can follow exactly"]}},visual_cues:{style_power:"Style is one of the most powerful levers for guiding the model. Establish early (e.g., '1970s film', 'IMAX-scale', '16mm black-and-white')",clarity_wins:"Instead of vague cues, use specific visuals",weak_vs_strong:[{category:"Visual Details",weak:"A beautiful street at night",strong:"Wet asphalt, zebra crosswalk, neon signs reflecting in puddles"},{category:"Movement",weak:"Person moves quickly",strong:"Cyclist pedals three times, brakes, and stops at crosswalk"},{category:"Camera Style",weak:"Cinematic look",strong:"Anamorphic 2.0x lens, shallow DOF, volumetric light"},{category:"Lighting",weak:"Brightly lit room",strong:"Soft window light with warm lamp fill, cool rim from hallway"}],camera_framing_examples:["wide establishing shot, eye level","wide shot, tracking left to right with the charge","aerial wide shot, slight downward angle","medium close-up shot, slight angle from behind"],camera_motion_examples:["slowly tilting camera","handheld eng camera","slow dolly-in from eye level","shoulder-mounted slow dolly left","slow arc in"]},motion_timing:{principle:"Movement is often the hardest part to get right, so keep it simple",rule:"Each shot should have ONE clear camera move and ONE clear subject action",beats_approach:"Actions work best when described in beats or counts",examples:{weak:"Actor walks across the room",strong:"Actor takes four steps to the window, pauses, and pulls the curtain in the final second"}},lighting_color:{importance:"Light determines mood as much as action or setting",consistency:"Keeping lighting logic consistent is what makes the edit seamless",description_approach:"Describe both quality of light and color anchors",examples:{weak:{lighting:"brightly lit room"},strong:{lighting:"soft window light with warm lamp fill, cool rim from hallway",palette:"amber, cream, walnut brown"}},tip:"Naming 3-5 colors helps keep palette stable across shots"},image_input:{purpose:"Use photos, digital artwork or AI generated visuals to lock composition and style",how_it_works:"Model uses image as anchor for first frame, text defines what happens next",requirements:["Include as input_reference parameter","Image MUST match target video resolution","Supported formats: image/jpeg, image/png, image/webp"],experimentation_tip:"Use OpenAI's image generation to create references, then pass to Sora"},dialogue_audio:{placement:"Place dialogue in block below prose description",guidelines:["Keep lines concise and natural","Limit exchanges to match clip length","Label speakers consistently","Use alternating turns for multi-character scenes"],timing:{"4_seconds":"1-2 short exchanges","8_seconds":"A few more exchanges possible"},sound_cues:"For silent shots, suggest pacing with small sound like 'distant traffic hiss' or 'crisp snap'",example:`A cramped, windowless room with walls the color of old ash...\nDialogue:\n- Detective: "You're lying. I can hear it in your silence."\n- Suspect: "Or maybe I'm just tired of talking."\n- Detective: "Either way, you'll talk before the night's over."`},remix:{philosophy:"Remix is for nudging, not gambling",approach:"Make controlled changes ‚Äì ONE at a time",examples:["same shot, switch to 85mm","same lighting, new palette: teal, sand, rust","same composition, change monster color to orange"],troubleshooting:"If shot keeps misfiring, strip back: freeze camera, simplify action, clear background"},ultra_detailed:{when_to_use:"For complex, cinematic shots matching real cinematography styles",components:["Format & Look (shutter, capture format, grain)","Lenses & Filtration (specific mm, filters)","Grade/Palette (highlights, mids, blacks)","Lighting & Atmosphere (natural/practical sources)","Location & Framing (foreground/midground/background)","Wardrobe/Props/Extras","Sound (diegetic only)","Camera Notes (eyeline, flares, imperfections)"],example_snippet:`Format & Look: Duration 4s; 180¬∞ shutter; digital capture emulating 65mm photochemical contrast; fine grain; subtle halation on speculars\nLenses: 32mm/50mm spherical primes; Black Pro-Mist 1/4\nGrade: Highlights - clean morning sunlight with amber lift; Mids - balanced neutrals with slight teal cast`},templates:{descriptive:`[Prose scene description in plain language]\n\nCinematography:\nCamera shot: [framing and angle]\nMood: [overall tone]\n\nActions:\n- [Action 1: clear specific beat]\n- [Action 2: distinct beat]\n- [Action 3: action or dialogue]\n\nDialogue:\n[If applicable, brief natural lines]`,structured_example:`Style: Hand-painted 2D/3D hybrid animation with soft brush textures\nInside a cluttered workshop, shelves overflow with gears...\n\nCinematography:\nCamera: medium close-up, slow push-in\nLens: 35mm virtual lens, shallow DOF\nMood: gentle, whimsical, touch of suspense\n\nActions:\n- Robot taps bulb; sparks crackle\n- It flinches, dropping bulb, eyes widening\n- Bulb tumbles in slow motion; catches it just in time\n- Robot says quietly: "Almost lost it... but I got it!"`},key_insights:["The right prompt balance depends on whether you prioritize consistency or creative surprise","Small changes to camera, lighting, or action can shift outcome dramatically","Collaborate with the model: you provide direction, model delivers variations","This isn't exact science ‚Äì treat guidance as helpful suggestions","Be prepared to iterate"]}});const s=`WEB PUBLISHING GUIDE\n\nCRITICAL REQUIREMENTS:\n- <title> tag MUST be descriptive (used for filename)\n- <meta charset="UTF-8"> required\n- <meta name="viewport" content="width=device-width, initial-scale=1.0"> for mobile\n- All CSS must be inline in <style> tag\n- Images can be external URLs\n\nMINIMAL STRUCTURE:\n<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Descriptive Page Title</title>\n  <style>\n    /* Your CSS here - be creative with design */\n  </style>\n</head>\n<body>\n  \x3c!-- Your content here --\x3e\n</body>\n</html>\n\nTIPS:\n- Use modern CSS (flexbox, grid, gradients, shadows)\n- Include hover effects and transitions\n- Add @media queries for mobile responsiveness\n- Use system fonts: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif\n\nBe creative with layout, colors, and design. Adapt to the user's brand and requirements.\n`;async function _upsertItem(e,t,s){try{await openkbs.updateItem({itemType:e,itemId:t,body:s})}catch(a){await openkbs.createItem({itemType:e,itemId:t,body:s})}return{success:true,itemId:t}}async function _deleteItem(e,t){try{await openkbs.deleteItem(t);return{success:true}}catch(e){return{success:false,error:e.message}}}async function setMemoryValue(e,t,s=null){if(!e.startsWith("memory_")){throw new Error(`Invalid memory itemId: "${e}". Must start with "memory_"`)}const a={value:t,updatedAt:(new Date).toISOString()};if(s!=null){a.exp=new Date(Date.now()+s*60*1e3).toISOString()}return _upsertItem("memory",e,a)}async function deleteItem(e){try{await openkbs.deleteItem(e);return{success:true}}catch(e){return{success:false,error:e.message}}}const uploadGeneratedImage=async(e,t)=>{const s=`image-${Date.now()}-${Math.random().toString(36).substring(7)}.png`;const a=await openkbs.uploadImage(e,s,"image/png");return{type:"CHAT_IMAGE",data:{imageUrl:a.url},...t}};const getActions=(e,t)=>[[/<getSora2PromptingGuide\s*\/>/s,async()=>({...getSora2PromptingGuide(),...e})],[/<getWebPublishingGuide\s*\/>/s,async()=>({type:"WEB_PUBLISHING_GUIDE",content:s,...e})],[/<setMemory>([\s\S]*?)<\/setMemory>/s,async e=>{try{const t=e[1].trim();const s=JSON.parse(t);if(!s.itemId?.startsWith("memory_")){return{type:"MEMORY_ERROR",error:"ItemId must start with 'memory_'",_meta_actions:["REQUEST_CHAT_MODEL"]}}await setMemoryValue(s.itemId,s.value,s.expirationInMinutes);return{type:"MEMORY_UPDATED",itemId:s.itemId,expires:s.expirationInMinutes?`in ${s.expirationInMinutes} minutes`:"never",_meta_actions:["REQUEST_CHAT_MODEL"]}}catch(e){return{type:"MEMORY_ERROR",error:e.message,_meta_actions:["REQUEST_CHAT_MODEL"]}}}],[/<deleteItem>([\s\S]*?)<\/deleteItem>/s,async e=>{try{const t=e[1].trim();const s=JSON.parse(t);const a=await deleteItem(s.itemId);if(!a.success){return{type:"DELETE_ERROR",error:a.error||"Failed to delete item",_meta_actions:["REQUEST_CHAT_MODEL"]}}return{type:"ITEM_DELETED",itemId:s.itemId,_meta_actions:["REQUEST_CHAT_MODEL"]}}catch(e){return{type:"DELETE_ERROR",error:e.message,_meta_actions:["REQUEST_CHAT_MODEL"]}}}],[/<createAIImage>([\s\S]*?)<\/createAIImage>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.model||"gemini-2.5-flash-image";const n=a.prompt;const o=a.imageUrls||[];const i=a.aspect_ratio;const c=a.size;const l={model:r,n:1};if(o.length>0){l.imageUrls=o}if(r==="gpt-image-1"){const e=["1024x1024","1536x1024","1024x1536","auto"];l.size=e.includes(c)?c:"1024x1024";l.quality="high"}else if(r==="gemini-2.5-flash-image"){const e=["1:1","2:3","3:2","3:4","4:3","4:5","5:4","9:16","16:9","21:9"];l.aspect_ratio=e.includes(i)?i:"1:1"}const d=await openkbs.generateImage(n,l);return await uploadGeneratedImage(d[0].b64_json,e)}catch(t){return{error:t.message||"Image creation failed",...e}}}],[/<createAIVideo>([\s\S]*?)<\/createAIVideo>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.model||"sora-2";const n=a.size||"1280x720";const o=a.seconds||8;const i=a.prompt;const c=a.input_reference_url;const l=[4,8,12];const d=l.includes(o)?o:l.reduce(((e,t)=>Math.abs(t-o)<Math.abs(e-o)?t:e));const m={video_model:r,seconds:d};if(c){m.input_reference_url=c}else if(n){const e=["720x1280","1280x720"];m.size=e.includes(n)?n:"1280x720"}const p=await openkbs.generateVideo(i,m);if(p&&p[0]&&p[0].status==="pending"){return{type:"VIDEO_PENDING",data:{videoId:p[0].video_id,message:"‚è≥ Video generation in progress. Please wait and DO NOT refresh your browser! Use continueVideoPolling to check status."},...e}}if(p&&p[0]&&p[0].video_url){return{type:"CHAT_VIDEO",data:{videoUrl:p[0].video_url},...e}}else{return{error:"Video generation failed - no video URL returned",...e}}}catch(t){return{error:t.message||"Video creation failed",...e}}}],[/<continueVideoPolling>([\s\S]*?)<\/continueVideoPolling>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.videoId;const n=await openkbs.checkVideoStatus(r);if(n&&n[0]){if(n[0].status==="completed"&&n[0].video_url){return{type:"CHAT_VIDEO",data:{videoUrl:n[0].video_url},...e}}else if(n[0].status==="pending"){return{type:"VIDEO_PENDING",data:{videoId:r,message:"‚è≥ Video still generating. Please wait and DO NOT refresh your browser! Continue polling."},...e}}else if(n[0].status==="failed"){return{error:"Video generation failed",...e}}}return{error:"Unable to get video status",...e}}catch(t){return{error:t.message||"Failed to check video status",...e}}}],[/<publishWebPage>([\s\S]*?)<\/publishWebPage>/s,async t=>{try{let s=t[1].trim();const a=s.match(/<title>(.*?)<\/title>/i);const r=a?a[1]:"Marketing Page";const n=Date.now();const o=r.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"page";const i=`${o}_${n}.html`;const c=await openkbs.kb({action:"createPresignedURL",namespace:"files",fileName:i,fileType:"text/html",presignedOperation:"putObject"});const l=Buffer.from(s,"utf8");const d=await axios.put(c,l,{headers:{"Content-Type":"text/html","Content-Length":l.length}});if(d.status<200||d.status>=300){throw new Error(`Upload failed with status ${d.status}`)}const m=`https://web.file.vpc1.us/files/${openkbs.kbId}/${i}`;return{type:"WEB_PAGE_PUBLISHED",data:{url:m,filename:i,title:r,message:`Website published successfully at ${m}`},...e}}catch(t){return{type:"PUBLISH_ERROR",error:t.message||"Failed to publish web page",...e}}}],[/<viewImage>([\s\S]*?)<\/viewImage>/s,async e=>{try{const t=e[1].trim();const s=JSON.parse(t);const a=s.url;return{data:[{type:"text",text:`Image loaded for analysis: ${a}`},{type:"image_url",image_url:{url:a}}],_meta_actions:["REQUEST_CHAT_MODEL"]}}catch(e){return{type:"VIEW_IMAGE_ERROR",error:e.message,_meta_actions:["REQUEST_CHAT_MODEL"]}}}],[/<webpageToText>([\s\S]*?)<\/webpageToText>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);let r=await openkbs.webpageToText(a.url,{parsePrice:true});if(r?.content?.length>5e3){r.content=r.content.substring(0,5e3)}return{data:r,...e}}catch(t){return{error:t.response?.data||t.message,...e}}}],[/<googleSearch>([\s\S]*?)<\/googleSearch>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.query;const n=await openkbs.googleSearch(r);const o=n?.map((({title:e,link:t,snippet:s,pagemap:a})=>({title:e,link:t,snippet:s,image:a?.metatags?.[0]?.["og:image"]})));return{data:o,...e}}catch(t){return{error:t.response?.data||t.message,...e}}}],[/<googleImageSearch>([\s\S]*?)<\/googleImageSearch>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.query;const n=a.limit||10;const o=await openkbs.googleSearch(r,{searchType:"image"});const i=o?.map((({title:e,link:t,snippet:s,pagemap:a})=>{const r=a?.cse_image?.[0];const n=r?.src||a?.metatags?.[0]?.["og:image"]||t;return{title:e,link:t,snippet:s,image:n}}))?.slice(0,n);return{data:i,...e}}catch(t){return{error:t.response?.data||t.message,...e}}}],[/<deepResearch>([\s\S]*?)<\/deepResearch>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.query||a.input;const n=a.previous_interaction_id;if(!r){return{error:"Missing query/input for deep research",...e}}const o={};if(n){o.previous_interaction_id=n}const i=await openkbs.deepResearch(r,o);if(i?.status==="in_progress"){return{type:"DEEP_RESEARCH_PENDING",data:{interactionId:i.interaction_id,prepaidCredits:i.prepaid_credits,message:"üî¨ Deep research in progress. This may take 5-20 minutes. Use continueDeepResearchPolling to check status."},...e}}if(i?.status==="completed"&&i?.output){return{type:"DEEP_RESEARCH_COMPLETED",data:{interactionId:i.interaction_id,output:i.output,usage:i.usage},...e}}return{error:"Deep research failed - unexpected response",...e}}catch(t){return{error:t.message||"Deep research failed",...e}}}],[/<continueDeepResearchPolling>([\s\S]*?)<\/continueDeepResearchPolling>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=a.interactionId;const n=a.prepaidCredits||0;if(!r){return{error:"Missing interactionId for deep research polling",...e}}const o=await openkbs.checkDeepResearchStatus(r,n);if(o?.status==="completed"&&o?.output){return{type:"DEEP_RESEARCH_COMPLETED",data:{interactionId:o.interaction_id,output:o.output,usage:o.usage},...e}}else if(o?.status==="in_progress"){return{type:"DEEP_RESEARCH_PENDING",data:{interactionId:r,prepaidCredits:o.prepaid_credits,message:"üî¨ Deep research still in progress. Please wait and continue polling."},...e}}else if(o?.status==="failed"){return{error:"Deep research failed",...e}}return{error:"Unable to get deep research status",...e}}catch(t){return{error:t.message||"Failed to check deep research status",...e}}}],[/<sendMail>([\s\S]*?)<\/sendMail>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=await openkbs.sendMail(a.to,a.subject,a.body);return{type:"EMAIL_SENT",data:{email:a.to,subject:a.subject,response:r},...e}}catch(t){return{error:t.response?.data||t.message,...e}}}],[/<scheduleTask>([\s\S]*?)<\/scheduleTask>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);let r;if(a.time){let e=a.time.replace(" ","T");if(!e.includes("Z")&&!e.includes("+")&&!e.includes("-")){e+="Z"}r=new Date(e).getTime()}else if(a.delay){let e=0;const t=a.delay;if(t.endsWith("h")){e=parseFloat(t)*60*60*1e3}else if(t.endsWith("d")){e=parseFloat(t)*24*60*60*1e3}else{e=parseFloat(t)*60*1e3}r=Date.now()+e}else{r=Date.now()+60*60*1e3}r=Math.floor(r/6e4)*6e4;const n=await openkbs.kb({action:"createScheduledTask",scheduledTime:r,taskPayload:{message:`[SCHEDULED_TASK] ${a.message}`,source:"marketing_agent_scheduled",createdAt:Date.now()},description:`Marketing task: ${a.message.substring(0,50)}${a.message.length>50?"...":""}`});return{type:"TASK_SCHEDULED",data:{scheduledTime:new Date(r).toISOString(),taskId:n.taskId,message:a.message},...e}}catch(t){return{error:t.response?.data||t.message||"Failed to schedule task",...e}}}],[/<getScheduledTasks\/>/s,async()=>{try{const t=await openkbs.kb({action:"getScheduledTasks"});return{type:"SCHEDULED_TASKS_LIST",data:t,...e}}catch(t){return{error:t.response?.data||t.message||"Failed to get scheduled tasks",...e}}}],[/<deleteScheduledTask>([\s\S]*?)<\/deleteScheduledTask>/s,async t=>{try{const s=t[1].trim();const a=JSON.parse(s);const r=await openkbs.kb({action:"deleteScheduledTask",timestamp:a.timestamp});return{type:"TASK_DELETED",data:{deletedTimestamp:a.timestamp,message:"Task deleted successfully"},...e}}catch(t){return{error:t.response?.data||t.message||"Failed to delete task",...e}}}],[/<archiveItems>([\s\S]*?)<\/archiveItems>/s,async e=>{try{const t=e[1].trim();const s=JSON.parse(t);if(!Array.isArray(s)||s.length===0){throw new Error("Must provide an array of itemIds to archive")}const a=[];const r="text-embedding-3-large";const n=3072;const o=Date.now();for(const e of s){try{const t=await openkbs.getItem(e);if(!t?.item?.body){a.push({itemId:e,status:"error",error:"Item not found"});continue}const s=t.item.body;const i=e.split("_")[0];let c="";if(i==="memory"){c=`${e}: ${typeof s.value==="string"?s.value:JSON.stringify(s.value)}`}else{c=`${e}: ${JSON.stringify(s)}`}const{embeddings:l,totalTokens:d}=await openkbs.createEmbeddings(c,r);const m=`archive_${o}_${e}`;const p={originalItemId:e,originalItemType:i,content:s,archivedAt:(new Date).toISOString()};await openkbs.items({action:"createItem",itemType:"archive",itemId:m,attributes:[{attrType:"itemId",attrName:"itemId",encrypted:false},{attrType:"body",attrName:"body",encrypted:true}],item:{body:await openkbs.encrypt(JSON.stringify(p))},totalTokens:d,embeddings:l?l.slice(0,n):undefined,embeddingModel:r,embeddingDimension:n});await deleteItem(e);a.push({itemId:e,archiveItemId:m,status:"success",tokens:d})}catch(t){a.push({itemId:e,status:"error",error:t.message})}}const i=a.filter((e=>e.status==="success")).length;const c=a.filter((e=>e.status==="error")).length;return{type:"ITEMS_ARCHIVED",summary:`Archived ${i} of ${s.length} items (${c} errors)`,results:a,_meta_actions:["REQUEST_CHAT_MODEL"]}}catch(e){return{type:"ARCHIVE_ERROR",error:e.message,_meta_actions:["REQUEST_CHAT_MODEL"]}}}],[/<searchArchive>([\s\S]*?)<\/searchArchive>/s,async e=>{try{const t=e[1].trim();const s=JSON.parse(t);if(!s.query){throw new Error('Must provide a "query" for semantic search')}const a=s.topK||10;const r=s.minScore||0;const n=await openkbs.items({action:"searchVectorDBItems",queryText:s.query,topK:a,minScore:r});const o=[];for(const e of n?.items||[]){try{let t=null;if(e.body){const s=await openkbs.decrypt(e.body);t=JSON.parse(s)}o.push({archiveItemId:e.itemId,originalItemId:t?.originalItemId,originalItemType:t?.originalItemType,content:t?.content,archivedAt:t?.archivedAt,score:e.score})}catch(t){o.push({archiveItemId:e.itemId,score:e.score,error:"Failed to decrypt: "+t.message})}}return{type:"ARCHIVE_SEARCH_RESULTS",query:s.query,count:o.length,results:o,_meta_actions:["REQUEST_CHAT_MODEL"]}}catch(e){return{type:"ARCHIVE_SEARCH_ERROR",error:e.message,_meta_actions:["REQUEST_CHAT_MODEL"]}}}]];const isContentArray=e=>Array.isArray(e?.data)&&e.data.some((e=>e?.type==="image_url"));const getMeta=e=>{const t=e.some((e=>e?._meta_actions?.includes("REQUEST_CHAT_MODEL")));return t?["REQUEST_CHAT_MODEL"]:[]};const backendHandler=async e=>{const t=e.payload.messages[e.payload.messages.length-1];const s=t.content||"";const a=getActions({_meta_actions:["REQUEST_CHAT_MODEL"]},e);const r=[];for(const[t,n]of a){const a=[...s.matchAll(new RegExp(t,"g"))];for(const t of a){r.push(n(t,e))}}if(r.length===0){return{type:"CONTINUE"}}try{const e=await Promise.all(r);const t=getMeta(e);if(e.some(isContentArray)){const s=[];for(const t of e){if(isContentArray(t)){s.push(...t.data)}else{s.push({type:"text",text:JSON.stringify(t,null,2)})}}return{data:s,_meta_actions:t}}return{type:"RESPONSE",results:e,_meta_actions:t}}catch(e){return{type:"ERROR",error:e.message,_meta_actions:["REQUEST_CHAT_MODEL"]}}};const a=backendHandler;module.exports=t})();